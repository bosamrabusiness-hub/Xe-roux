<!-- Powered by BMAD™ Core -->

# Story 1.06: Observability & Monitoring (Logs, Metrics, Alerts)

**Status:** Done  
**Epic:** 1 – Core Backend Service  
**Created:** 2025-10-16  
**Author:** PO Agent

---

## Story
**As an** operator of ClipX,  
**I want** centralized logs, error tracking, and basic metrics with alerting,  
**so that** I can quickly identify issues, ensure uptime, and maintain service quality.

---

## Acceptance Criteria
1. Structured JSON logs emitted via Loguru or stdlib `logging` formatter for all requests and Celery tasks.
2. Integrate Sentry (free tier) for uncaught exceptions in FastAPI and Celery workers; release/tag set via env `SENTRY_DSN`.
3. Expose `/metrics` endpoint (Prometheus format) using `prometheus-fastapi-instrumentator` covering HTTP requests and Celery task durations.
4. Add GitHub Action workflow to run `promtool` rules validation on alert rules.
5. Basic alert rules YAML added: high error rate (>5% in 5m) and high latency (>2s p95).
6. UptimeRobot ping monitors configured for `/healthz` and `/metrics` endpoints (documented, not hard-coded).
7. `/healthz` now includes check that Sentry DSN is registered (if provided) and Redis / Celery heartbeat.
8. README updated with setup instructions for Sentry project, Prometheus scraping config, and UptimeRobot monitors.
9. Unit tests assert that `/metrics` returns 200 with expected metric names.
10. Logging & Sentry integration do not leak sensitive env vars (validated in tests).

---

## Tasks / Subtasks
- [ ] Add dependencies `loguru`, `sentry-sdk`, `prometheus-fastapi-instrumentator` to `requirements.txt`.
- [ ] Configure Loguru logger with JSON sink; propagate to Uvicorn.
- [ ] Initialize Sentry in `app/main.py` if `SENTRY_DSN` env present; include `release`, `environment`.
- [ ] Add Instrumentator middleware registering default metrics and custom Celery task metrics.
- [ ] Create `infra/prometheus/alert_rules.yml` with error-rate & latency alerts.
- [ ] Update GitHub Actions to install `prometheus-toolkit` and validate rules.
- [ ] Document UptimeRobot monitor creation in README.
- [ ] Write tests hitting `/metrics` and parsing text for `http_server_requests_seconds_count`.
- [ ] Scrub log output in tests to ensure no secrets appear.

---

## Dev Notes
- Log format sample: `{ "ts": "ISO8601", "level": "INFO", "method": "POST", "path": "/download", "status": 202, "duration_ms": 145 }`.
- Celery: use `after_setup_task_logger` to attach Loguru handler.
- Add histogram for download duration labeled by status (success/failure).
- Prometheus scraping may not be supported on Render free tier; suggest Pushgateway fallback (document optional).

---

## Testing Standards
- Use `httpx.AsyncClient` to request `/metrics` during test app lifespan.
- Utilize `caplog` to capture log records and assert JSON keys.
- Mock Sentry SDK `init` to avoid network.
- Aim for overall coverage ≥ 80 %.

---

## Change Log
| Date       | Version | Description                        | Author     |
|------------|---------|------------------------------------|------------|
| 2025-10-16 | 1.0     | Initial story created              | PO Agent   |

---

## Dev Agent Record
*Populated by dev agent during implementation.*

### Agent Model Used
*

### Debug Log References
*

### Completion Notes
*

### File List
*