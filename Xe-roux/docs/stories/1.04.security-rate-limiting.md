<!-- Powered by BMAD™ Core -->

# Story 1.04: Security & Abuse Prevention (Rate Limiting + URL Validation)

**Status:** In Progress  
**Epic:** 1 – Core Backend Service  
**Created:** 2025-10-16  
**Author:** PO Agent

---

## Story
**As a** responsible service operator,  
**I want** to validate incoming URLs and apply per-IP rate limiting,  
**so that** ClipX mitigates abuse, protects backend resources, and stays within free-tier limits.

---

## Acceptance Criteria
1. Backend validates every `url` parameter: accepts only http/https schemes, rejects private/reserved IP ranges (RFC1918, localhost, 0.0.0.0, etc.).
2. Malformed or blocked URLs return 400 with clear error message.
3. Global per-IP rate limit: max 10 requests/minute; configurable via env `RATE_LIMIT_REQUESTS` & `RATE_LIMIT_PERIOD`.
4. Separate stricter limit for `POST /download`: max 3 downloads per IP per 30 minutes.
5. Implemented using `fastapi-limiter` (Redis backend) leveraging Redis already provisioned in Story 1.03.
6. When over limit, endpoints return 429 JSON `{ detail: 'Rate limit exceeded. Try again later.' }` with `Retry-After` header.
7. All limits logged in structured JSON with user IP, endpoint, remaining quota.
8. Update `/healthz` to include limiter ping to Redis.
9. Update OpenAPI schema to document possible 400 & 429 responses.
10. Unit tests cover URL validation edge cases and rate-limit behaviour (mock Redis time).
11. README section “Security & Rate Limiting” added with env vars and tuning guidance.

---

## Tasks / Subtasks
- [x] Add `utils/validators.py` with `validate_url(url: str) -> str` raising `HTTPException` 400.
- [x] Add dependency `fastapi-limiter` to `requirements.txt`.
- [x] Configure `FastAPILimiter.init(app, redis_url)` in startup event.
- [x] Decorate `/preview`, `/download`, `/download/status/{id}` with `@Limiter.rate_limit()` per AC.
- [x] Extend `download.py` router to call `validate_url` early.
- [x] Add custom exception handler for `429` to return JSON & headers.
- [ ] Implement logging middleware capturing limiter headers.
- [ ] Write unit tests in `tests/security/` for validation and rate limiting.
- [ ] Update swagger docs with response model annotations.
- [ ] Document new env vars in `.env.example` and README.

---

## Dev Notes
- Reserved IP check: use `urllib.parse` + `ipaddress` to parse host; if host resolves to IP, check if it is private, loopback, multicast, etc.
- For domains, optional DNS resolution with timeout to prevent SSRF; KISS for MVP: allow domain but block explicit `file://`, `ftp://`, etc.
- `fastapi-limiter` requires `X-Forwarded-For` header when behind Vercel/Render; document proxy settings.
- Use `redis://` set in existing `REDIS_URL`; reuse connection from Celery if possible.

---

## Testing Standards
- Use `freezegun` or manual monkeypatch time for rate limit window tests.
- Ensure tests run with ephemeral Redis via docker-compose or `fakeredis`.
- Maintain overall coverage ≥ 80 %.

---

## Change Log
| Date       | Version | Description                        | Author     |
|------------|---------|------------------------------------|------------|
| 2025-10-16 | 1.0     | Initial story created              | PO Agent   |

---

## Dev Agent Record
*Populated by dev agent during implementation.*

### Agent Model Used
*

### Debug Log References
*

### Completion Notes
*

### File List
*