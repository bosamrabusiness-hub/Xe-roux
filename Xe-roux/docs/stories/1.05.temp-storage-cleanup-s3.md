<!-- Powered by BMAD™ Core -->

# Story 1.05: Temporary Storage Cleanup & Optional S3 Upload

**Status:** In Progress  
**Epic:** 1 – Core Backend Service  
**Created:** 2025-10-16  
**Author:** PO Agent

---

## Story
**As a** backend maintainer,  
**I want** automatic cleanup of `/tmp` files and an option to off-load completed downloads to S3/Spaces,  
**so that** disk space stays under free-tier limits and we can scale to larger files without running out of storage.

---

## Acceptance Criteria
1. Background cleanup task deletes files in `/tmp` older than configurable `TTL_MINUTES` (default 10) and logs summary.
2. Env var `ENABLE_S3_UPLOAD` toggles optional upload path; when true, completed downloads are pushed to S3-compatible bucket (DigitalOcean Spaces) and served via presigned URL.
3. When uploaded, `fileUrl` in status response points to presigned URL valid 1 hour; local copy still deleted after upload.
4. S3 credentials (`S3_ENDPOINT`, `S3_ACCESS_KEY`, `S3_SECRET_KEY`, `S3_BUCKET`) read from env and never logged.
5. Implementation uses `boto3` with path-style endpoint support (for Spaces) and minimal dependency footprint.
6. Upload task runs in same Celery worker (Story 1.03) after download completes; retried up to 3 times on failure.
7. `/healthz` checks for write/list permission to bucket when S3 enabled.
8. Unit tests mock S3 client; integration test uses `localstack` optional.
9. README updated with instructions for enabling S3 offload and cost considerations.

---

## Tasks / Subtasks
- [x] Add dependency `boto3` to `requirements.txt`.
- [x] Implement `services/storage.py` with `upload_to_s3(path) -> url` handling multipart >= 5 MB.
- [x] Update `downloader.py` workflow: after yt-dlp success, call upload if enabled; update task meta with presigned URL.
- [x] Add `cleanup.py` async loop (FastAPI lifespan) or Celery periodic task deleting old tmp files.
- [ ] Update docker-compose to include `localstack` service for local S3 testing (optional).
- [x] Expand `.env.example` with all S3 variables.
- [ ] Write unit tests for uploader (mock `boto3.client`).
- [ ] Integration test using `moto` or `localstack` ensuring presigned URLs returned.
- [ ] Update OpenAPI docs to reflect possible presigned URL in `fileUrl`.

---

## Dev Notes
- Use `os.stat().st_mtime` to compute age; run cleanup every 60 seconds.
- Ensure concurrency safety: cleanup should skip files still being written (consider lock file or check mtime+running tasks).
- For low memory, disable multipart threshold to 8 MB; large files may exceed free memory—monitor.
- S3 SDK logging disabled; enable debug only via env `S3_DEBUG`.

---

## Testing Standards
- Coverage for cleanup age logic edge cases.
- Use `freezegun` to simulate time passage in tests.
- Integration tests skipped on CI if docker not available (mark optional).

---

## Change Log
| Date       | Version | Description                        | Author     |
|------------|---------|------------------------------------|------------|
| 2025-10-16 | 1.0     | Initial story created              | PO Agent   |

---

## Dev Agent Record
*Populated by dev agent during implementation.*

### Agent Model Used
*

### Debug Log References
*

### Completion Notes
*

### File List
*