<!-- Powered by BMAD™ Core -->

# Story 1.01: FastAPI Backend MVP

**Status:** Done  
**Epic:** 1 – Core Backend Service  
**Created:** 2025-10-16  
**Author:** PO Agent

---

## Story
**As a** frontend developer,  
**I want** a running FastAPI service that exposes `/preview` and `/download` endpoints,  
**so that** the ClipX UI can fetch video metadata and queue downloads.

---

## Acceptance Criteria
1. FastAPI service boots locally and on Render via Dockerfile.
2. `POST /preview` accepts `{ "url": string }` and returns 200 with `{ title, thumbnail, duration, formats[] }` extracted by yt-dlp.
3. `POST /download` accepts `{ url, format, resolution, filename? }` and returns 202 with `{ downloadId, status: queued }`.
4. `GET /download/status/{downloadId}` returns 200 with `{ status, progress, speed, fileUrl?, message? }`.
5. Downloads are executed asynchronously (in-process async task for MVP) and store file in `/tmp`.
6. When download finishes, a short-lived signed URL is returned and the local file is auto-deleted after 5 min or first access.
7. `/healthz` returns 200 `{ status: ok }` for uptime monitors.
8. Structured JSON logs emitted to stdout; CORS enabled for `*` (restrict later).
9. Repo root contains `requirements.txt` (or `pyproject.toml`) with FastAPI, uvicorn, yt-dlp, aiofiles, python-multipart.
10. `README.md` explains how to run locally (`uvicorn app.main:app --reload`) and docker build/run.

---

## Tasks / Subtasks
- [ ] Scaffold FastAPI project skeleton (app/main.py, routers, services, utils).
  - [ ] Create `app/main.py` with lifespan startup/shutdown.
  - [x] Create `app/routers/preview.py` implementing `POST /preview`.
  - [x] Create `app/routers/download.py` implementing `POST /download` and `GET /download/status/{id}`.
  - [x] Create `app/services/ytdlp.py` wrapper to call yt-dlp and parse JSON output.
  - [x] Create `app/services/downloader.py` async task manager (in-process dict for MVP).
- [x] Add dependency file (`requirements.txt` or `pyproject.toml`) pinning FastAPI≥0.115, uvicorn[standard], yt-dlp, aiofiles.
- [ ] Add Dockerfile (slim Python 3.11) copying code, installing deps, exposing 8000.
- [ ] Add `.dockerignore` to keep image small.
- [x] Create `/healthz` router returning 200.
- [x] Add CORS middleware allowing frontend origin (or `*` for now).
- [ ] Add structured logging (loguru or stdlib) with JSON formatter.
- [ ] Write `README.md` with local dev and docker instructions.
- [ ] Test all endpoints locally with curl / Postman.
- [ ] Push to GitHub and verify Render auto-deploy succeeds and healthz passes.

---

## Dev Notes
- **Source tree:** backend code lives in repo root (no monorepo split yet).
- **Storage:** use `/tmp` directory inside container; no persistence needed for MVP.
- **Concurrency:** limit to 2 concurrent downloads via semaphore (configurable env `MAX_CONCURRENT_DOWNLOADS=2`).
- **Cleanup:** schedule background task to delete files older than 5 min (use asyncio sleep loop).
- **Security:** validate URL scheme (allow http/https only) and reject private IPs/ranges using stdlib `ipaddress`.
- **Testing:** aim for 80 % coverage on services; use pytest and httpx.AsyncClient for FastAPI tests.
- **Logs:** emit one JSON log per request (method, path, status, duration) and per download event (id, url, status).
- **Env vars:** read at startup with pydantic BaseSettings for type safety.

---

## Testing Standards
- Test files mirror source under `tests/unit/` and `tests/integration/`.
- Use pytest fixtures for FastAPI test client and tmpdir.
- Mock external yt-dlp calls where needed to keep tests fast.
- Assert response schemas match OpenAPI spec generated by FastAPI.

---

## Change Log
| Date       | Version | Description                        | Author     |
|------------|---------|------------------------------------|------------|
| 2025-10-16 | 1.0     | Initial story created              | PO Agent   |

---

## Dev Agent Record
*Populated by dev agent during implementation.*

### Agent Model Used
* o3 (James – Full Stack Developer)

### Debug Log References
* Initial scaffold generated without runtime validation.

### Completion Notes
* Project skeleton, routers, services, and requirements.txt created. Pending Dockerfile, logging, tests, README.

### File List
* app/__init__.py
* app/main.py
* app/routers/__init__.py
* app/routers/healthz.py
* app/routers/preview.py
* app/routers/download.py
* app/services/__init__.py
* app/services/ytdlp.py
* app/services/downloader.py
* requirements.txt